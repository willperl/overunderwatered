<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Gradio Plant Health Classifier</title>
	<style>
		body {
			font-family: sans-serif;
			margin: 2rem;
		}
		#result {
			margin-top: 1rem;
			padding: 1rem;
			border: 1px solid #ccc;
			border-radius: 0.5rem;
			background: #f9f9f9;
		}
		.confidence-bar {
			background: #ddd;
			border-radius: 4px;
			margin-top: 4px;
			position: relative;
			height: 20px;
		}
		.confidence-fill {
			background: #4caf50;
			height: 100%;
			border-radius: 4px;
			position: absolute;
			left: 0;
			top: 0;
		}
	</style>
</head>
<body>

	<h1>Upload an Image of Your Plant</h1>
	<form id="uploadForm">
		<input type="file" id="fileInput" accept="image/*" required>
		<button type="submit">Submit</button>
	</form>

	<div id="result" hidden></div>

	<script>
	async function callGradioWithFile(file) {
		const base64 = await new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.onload = () => resolve(reader.result.split(',')[1]);
			reader.onerror = reject;
			reader.readAsDataURL(file);
		});

		const payload = {
			data: [
				{
					name: file.name,
					data: base64,
					mime_type: file.type,
					meta: { _type: "gradio.FileData" }
				}
			]
		};

		const predictURL = "https://smittens-overorunderwatered.hf.space/gradio_api/call/predict";

		// Step 1: Submit prediction request
		const response = await fetch(predictURL, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify(payload)
		});
		const { event_id } = await response.json();

		// Step 2: Poll until response contains data
		const resultURL = `${predictURL}/${event_id}`;

		for (let attempt = 0; attempt < 10; attempt++) {
			const resultRes = await fetch(resultURL);
			const resultText = await resultRes.text();

			const match = resultText.match(/^data:\s*(.*)$/m);
			if (match && match[1]) {
				try {
					return JSON.parse(match[1]);
				} catch (err) {
					console.warn("Failed to parse data, retrying...");
				}
			}

			// Wait 500ms before retrying
			await new Promise(res => setTimeout(res, 500));
		}

		throw new Error("No prediction result after multiple attempts");
	}


	document.getElementById("uploadForm").addEventListener("submit", async (e) => {
		e.preventDefault();

		const file = document.getElementById("fileInput").files[0];
		if (!file) return;

		const resultDiv = document.getElementById("result");
		resultDiv.hidden = false;
		resultDiv.innerHTML = "<em>Loading...</em>";

		try {
			const output = await callGradioWithFile(file);

			const prediction = output[0];
			const label = prediction.label;
			const confidences = prediction.confidences;

			let html = `<h2>Prediction: ${label}</h2>`;
			html += `<div><strong>Confidence scores:</strong></div>`;

			for (const c of confidences) {
				const percent = (c.confidence * 100).toFixed(2);
				html += `
					<div>${c.label} (${percent}%)</div>
					<div class="confidence-bar">
						<div class="confidence-fill" style="width: ${percent}%;"></div>
					</div>
				`;
			}

			resultDiv.innerHTML = html;
		} catch (err) {
			console.error(err);
			resultDiv.innerHTML = `<strong>Error:</strong> ${err.message}`;
		}
	});
	</script>

</body>
</html>
