---
title: 3. Tester
layout: page
---

<input type="file" id="fileInput" required>
<button onclick="handleUpload()">Upload + Classify</button>
<pre id="output"></pre>

<script>
async function uploadToTmpfiles(file) {
	const formData = new FormData();
	formData.append("file", file);

	const res = await fetch("https://tmpfiles.org/api/v1/upload", {
		method: "POST",
		body: formData
	});

	const json = await res.json();
	if (!json || !json.data || !json.data.url) {
		throw new Error("Failed to upload to tmpfiles.org");
	}
	console.log("üåç Uploaded file URL:", json.data.url);
	return json.data.url;
}

async function callGradioWithURL(fileURL) {
	const payload = {
		data: [
			{
				path: fileURL,
				meta: { _type: "gradio.FileData" }
			}
		]
	};

	const predictURL = "https://smittens-overorunderwatered.hf.space/gradio_api/call/predict";
	const response = await fetch(predictURL, {
		method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify(payload)
	});

	const result = await response.json();
	const eventId = result.event_id;
	if (!eventId) throw new Error("No event ID returned");

	const streamRes = await fetch(`${predictURL}/${eventId}`);
	const rawText = await streamRes.text();

	console.log("üì• Raw response:\n" + rawText);

	const match = rawText.match(/^data:\s*(.*)$/m);
	if (!match || !match[1]) throw new Error("No valid data in response");

	const parsed = JSON.parse(match[1]);
	console.log("üéâ Parsed result:", parsed);
	return parsed;
}

async function handleUpload() {
	const file = document.getElementById("fileInput").files[0];
	const output = document.getElementById("output");

	if (!file) return;

	output.textContent = "üì§ Uploading file...";

	try {
		const url = await uploadToTmpfiles(file);
		output.textContent = "üß† Classifying...";

		const result = await callGradioWithURL(url);
		output.textContent = "‚úÖ Result:\n" + JSON.stringify(result, null, 2);
	} catch (err) {
		console.error(err);
		output.textContent = "‚ùå Error: " + err.message;
	}
}
</script>
