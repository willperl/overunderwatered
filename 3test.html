---
title: 3. Tester
layout: page
---

<input type="file" id="fileInput" />
	<button onclick="handleUpload()">Classify</button>

	<pre id="output">Waiting...</pre>

	<div id="chart-container" style="margin-top: 1rem;">
	<div id="chart-label" style="font-weight: bold;"></div>
	<div id="chart-bar" style="background-color: #4CAF50; height: 24px; width: 0;"></div>
	</div>

	<script>
		const predictURL = "https://smittens-overorunderwatered.hf.space/gradio_api/call/predict";

		async function handleUpload() {
			const fileInput = document.getElementById("fileInput");
			const output = document.getElementById("output");

			if (!fileInput.files[0]) {
				output.textContent = "Please select a file.";
				return;
			}

			output.textContent = "Uploading to file.io...";

			const uploadRes = await uploadToFileIO(fileInput.files[0]);

			if (!uploadRes.success) {
				output.textContent = "Upload failed.";
				return;
			}

			const fileURL = uploadRes.link.replace("tmpfiles.org/", "tmpfiles.org/dl/");
			output.textContent = `File uploaded: ${fileURL}\nCalling Gradio...`;
			console.log("Uploaded file URL:", fileURL);

			try {
				const result = await callGradioAPI(fileURL);
				const parsed = JSON.parse(result.data);
				const top = parsed[0].confidences.sort((a, b) => b.confidence - a.confidence)[0];

				// Update output text (optional)
				output.innerText = `üéâ Top result: ${top.label} (${(top.confidence * 100).toFixed(1)}%)`;

				// Update chart
				const labelEl = document.getElementById("chart-label");
				const barEl = document.getElementById("chart-bar");

				labelEl.innerText = top.label;
				barEl.style.width = `${top.confidence * 100}%`;
				barEl.innerText = `${(top.confidence * 100).toFixed(1)}%`;

				// output.textContent = `üéâ Result:\n${JSON.stringify(result, null, 2)}`;
			} catch (err) {
				output.textContent = `‚ùå Error: ${err.message}`;
			}
		}

		async function uploadToFileIO(file) {
			const formData = new FormData();
			formData.append("file", file);

			const res = await fetch("https://tmpfiles.org/api/v1/upload", {
				method: "POST",
				body: formData
			});
			const json = await res.json();

			// Their API returns relative URLs like `/abc123`
			return { success: true, link: json.data.url };
		}


		async function callGradioAPI(imageURL) {
			const payload = {
				data: [
					{
						path: imageURL,
						meta: { _type: "gradio.FileData" }
					}
				]
			};

			const res = await fetch(predictURL, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(payload)
			});

			const { event_id } = await res.json();
			const stream = await fetch(`${predictURL}/${event_id}`);
			const raw = await stream.text();

			console.log("Raw response:\n", raw);

			const match = raw.match(/^data:\s*(.*)$/m);
			if (!match) throw new Error("No JSON in stream");

			return JSON.parse(match[1]);
		}
	</script>